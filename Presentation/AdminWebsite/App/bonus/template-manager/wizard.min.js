(function(){var n=function(n,t){return function(){return n.apply(t,arguments)}};define(["komapping","nav","bonus/bonusCommon","i18next","bonus/template-manager/info","bonus/template-manager/availability","bonus/template-manager/rules","bonus/template-manager/wagering","bonus/template-manager/notification","bonus/template-manager/summary","bonus/template-manager/rewardTier","dateBinders","wizard"],function(t,i,r,u,f,e,o,s,h,c,l){return function(){function a(){this.getCurrentWizardCount=n(this.getCurrentWizardCount,this);this.disable=n(this.disable,this);this.enable=n(this.enable,this);this.toggleButtonsVisibility=n(this.toggleButtonsVisibility,this);this.showNext=n(this.showNext,this);this.show=n(this.show,this);this.compositionComplete=n(this.compositionComplete,this);this.bindingComplete=n(this.bindingComplete,this);this.activate=n(this.activate,this);this.submit=n(this.submit,this);var t,i;this.Id=ko.observable();this.Version=ko.observable();this.serverErrors=ko.observable();this.steps=[{index:0,name:"Info"},{index:1,name:"Availability"},{index:2,name:"Rules"},{index:3,name:"Wagering"},{index:4,name:"Notification"},{index:5,name:"Summary"}];this.initialStep=this.steps[0];this.allowedSteps=ko.observableArray([this.steps[0]]);this.wizardSelector=".template-wizard";i=this.getCurrentWizardCount();this.tabs=function(){var n,r,f;for(f=[],t=n=0,r=this.steps.length-1;0<=r?n<=r:n>=r;t=0<=r?++n:--n)f.push({tabId:"tab"+(i*10+t),stepNumber:t+1,stepName:u.t("bonus.wizardSteps."+t)});return f}.call(this);this.prevBtnClass="wizard-prev"+i;this.nextBtnClass="wizard-next"+i;this.closeBtnText=ko.observable();this.isNextBtnVisible=ko.observable(!0);this.isPrevBtnVisible=ko.observable(!0)}return a.prototype.close=function(){return i.close()},a.prototype.submit=function(n,i,u){var f,e,o,s;return(this.Rules.isFundIn()===!1&&this.Rules.FundInWallets([]),this.Rules.isReferFriends()===!1&&(this.Rules.ReferFriendMinDepositAmount(0),this.Rules.ReferFriendWageringCondition(0)),u===1&&$.get("/bonusTemplate/getRiskLevels",{brandId:this.Info.currentBrand().Id}).done(function(n){return function(t){return n.Availability.riskLevels.removeAll(),t.riskLevels.forEach(function(t){return n.Availability.riskLevels.push(t)})}}(this)),s=ko.utils.arrayFirst(this.steps,function(n){return n.index===u-1}),o=s.name,f=this[o],f.isValid()===!1)?(f.errors.showAllMessages(),!1):(this.Availability.VipLevels(this.Availability.vVipLevels().length===this.Availability.availableVips().length?[]:this.Availability.vVipLevels()),f.tracker.isDirty()?(e={Id:this.Id(),Version:this.Version()},e[o]=JSON.parse(t.toJSON(f,{ignore:r.getIgnoredFieldNames(f)})),$.ajax({type:"POST",url:"/bonusTemplate/createEdit",data:postJson(e),dataType:"json",traditional:!0}).done(function(n){return function(t){if(n.serverErrors(null),t.Success){if(n.Id(t.Id),n.Version(t.Version),$(document).trigger("bonus_templates_changed"),f.tracker.markCurrentStateAsClean(),n.showNext(ko.utils.arrayFirst(n.steps,function(n){return n.index===u})),u===2&&n.Info.allowChangeBrand(!1),u===1)return n.Info.allowChangeType(!1)}else return t.Errors.forEach(function(t){var i;return i=t.PropertyName.split("."),i[0]==="Template"||i[1]==="GameContributions"||i[1]==="RewardTiers"?n.serverErrors([t.ErrorMessage]):setError(n[i[0]][i[1]],t.ErrorMessage)}),f.errors.showAllMessages()}}(this)),!1):!0)},a.prototype.activate=function(n){return $.get("/bonusTemplate/getRelatedData",{id:n!=null?n.id:void 0}).done(function(i){return function(r){var u,g,p,w,nt,tt,b,a,k,d,it,v,y;if(i.Info=new f(r.licensees),i.Availability=new e(i.Info.currentBrand,r.bonuses,r.riskLevels),i.Rules=new o(i.Info.TemplateType,i.Info.currentBrand),i.Wagering=new s(i.Rules.isFirstOrReloadDeposit,i.Rules.isFundIn,r.games,i.Info.currentBrand),i.Notification=new h(r.notificationTemplates),i.Summary=new c(i.Info,i.Availability,i.Rules,i.Wagering,i.Notification),n!=null)if(i.Info.allowChangeType(!1),i.Info.allowChangeBrand(!1),y=r.template,b={ignore:function(){var n=[];for(a in y)y[a]===null&&n.push(a);return n}()},b.RewardTiers={create:function(n){return new l(n.data)}},t.fromJS(y,b,i),i.Info.BrandId.valueHasMutated(),i.Rules.currencies(function(){var n,r,t,i;for(t=this.Rules.RewardTiers(),i=[],n=0,r=t.length;n<r;n++)it=t[n],i.push(it.CurrencyCode);return i}.call(i)),n.view!==void 0)i.initialStep=i.steps[5],i.allowedSteps(i.steps[5]);else{for(u=[],k=function(){var n=[];for(a in y)y[a]!==null&&n.push(a);return n}(),p=0,nt=k.length;p<nt;p++)for(a=k[p],d=i.steps,w=0,tt=d.length;w<tt;w++)v=d[w],v.name===a&&u.push(v);u.length<i.steps.length-1&&(g=u[u.length-1].index+1,v=ko.utils.arrayFirst(i.steps,function(n){return n.index<5&&n.index===g}),v.skipMarkAsClean=!0,u.push(v));n.complete&&u.push(i.steps[5]);i.allowedSteps(u)}return i.Rules.selectRewardType(i.Rules.RewardType()),i.Wagering.selectWageringMethod(i.Wagering.Method())}}(this))},a.prototype.bindingComplete=function(){var n,t,f,e,r,u,i;for(this.element=$(this.wizardSelector).last().bootstrapWizard({tabClass:"nav nav-pills nav-justified",previousSelector:"."+this.prevBtnClass,nextSelector:"."+this.nextBtnClass,onNext:this.submit,onTabClick:function(n){return function(t,i,r,u){var f;return f=ko.utils.arrayFilter(n.allowedSteps(),function(n){return n.index===u}),f.length>0}}(this),onTabShow:this.toggleButtonsVisibility}),r=this.steps,n=0,f=r.length;n<f;n++)i=r[n],this.disable(i);for(u=this.allowedSteps(),t=0,e=u.length;t<e;t++)i=u[t],this.enable(i);return this.show(this.initialStep)},a.prototype.compositionComplete=function(){var n,u,i,f,t,r;for(i=this.allowedSteps(),t=[],n=0,u=i.length;n<u;n++)r=i[n],r.skipMarkAsClean===void 0?t.push((f=this[r.name].tracker)!=null?f.markCurrentStateAsClean():void 0):t.push(void 0);return t},a.prototype.show=function(n){return this.element.bootstrapWizard("show",n.index)},a.prototype.showNext=function(n){return this.allowedSteps.push(n),this.enable(n),this.show(n)},a.prototype.toggleButtonsVisibility=function(n,t,i){var r;return this.closeBtnText(u.t("common.close")),this.isNextBtnVisible(!0),this.isPrevBtnVisible(!0),r=this.steps[i],r===this.steps[0]&&this.isPrevBtnVisible(!1),r===this.steps[5]&&(this.closeBtnText(u.t("bonus.templateManager.finish")),this.isNextBtnVisible(!1)),this.initialStep===this.steps[5]?(this.closeBtnText(u.t("common.close")),this.isPrevBtnVisible(!1),this.isNextBtnVisible(!1)):void 0},a.prototype.enable=function(n){return this.element.bootstrapWizard("enable",n.index)},a.prototype.disable=function(n){return this.element.bootstrapWizard("disable",n.index)},a.prototype.getCurrentWizardCount=function(){var r,t,u,f,e,i,n;return i=0,n=$(this.wizardSelector+" a[data-toggle='tab']"),n.length>0&&(t=function(){var t,r,i;for(i=[],t=0,r=n.length;t<r;t++)f=n[t],i.push($(f).attr("href"));return i}(),e=function(){var n,u,i;for(i=[],n=0,u=t.length;n<u;n++)r=t[n],i.push(parseInt(r.slice(4)));return i}(),u=Math.max.apply(Math,e),i=Math.floor(u/10)+1),i},a}()})}).call(this);
//# sourceMappingURL=wizard.min.js.map
