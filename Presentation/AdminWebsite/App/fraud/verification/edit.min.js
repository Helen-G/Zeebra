(function(){define(["nav","durandal/app","i18next","security/security","shell","controls/grid","JqGridUtil","CommonNaming","EntityFormUtil","fraud/verification/WinningRule","dateTimePicker","dateBinders"],function(n,t,i,r,u,f,e,o,s,h){return function(){function t(){var t,u,f,n,r;n=this;this.self2=this;this.disabled=ko.observable(!1);this.editMode=ko.observable(!1);this.configuration={};this.form=new s.Form(this);this.dummyObservable=ko.observable();this.message=ko.observable;this.messageClass=ko.observable;this.operators=ko.observableArray([{text:">",value:0},{text:"<",value:1},{text:">=",value:2},{text:"<=",value:3}]);s.setupLicenseeField2(this);s.setupBrandField2(this);this.form.makeField("hasWinLoss",ko.observable(!1));this.form.makeField("hasCompleteDocuments",ko.observable(!1));this.form.makeField("winLossOperator",ko.observable());this.winLossOperatorTitle=ko.computed(function(){return n.getOperator(n.fields.winLossOperator())});this.form.makeField("winLossAmount",ko.observable(0).extend({formatDecimal:2,validatable:!0,validation:[{validator:function(){return function(t){return n.dummyObservable(),!n.fields.hasWinLoss()||t>=0}}(this),message:i.t("app:common.validationMessages.amountGreaterOrEquals",{amount:0})}],min:{params:0,message:i.t("app:common.validationMessages.amountGreaterOrEquals",{amount:0})},max:{params:2147483647,message:i.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasTotalDepositAmount",ko.observable(!1));this.form.makeField("totalDepositAmountOperator",ko.observable());this.totalDepositAmountOperatorTitle=ko.computed(function(){return n.getOperator(n.fields.totalDepositAmountOperator())});this.form.makeField("totalDepositAmount",ko.observable(.01).extend({formatDecimal:2,validatable:!0,validation:[{validator:function(){return function(t){return n.dummyObservable(),!n.fields.hasTotalDepositAmount()||t>=0}}(this),message:i.t("app:common.validationMessages.amountGreaterOrEquals",{amount:.01})}],min:{params:.01,message:i.t("app:common.validationMessages.amountGreaterOrEquals",{amount:.01})},max:{params:2147483647,message:i.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasWithdrawalCount",ko.observable(!1));this.form.makeField("totalWithdrawalCountOperator",ko.observable());this.totalWithdrawalCountOperatorTitle=ko.computed(function(){return n.getOperator(n.fields.totalWithdrawalCountOperator())});this.form.makeField("totalWithdrawalCountAmount",ko.observable(1).extend({formatInt:0,validatable:!0,validation:[{validator:function(){return function(t){return n.dummyObservable(),!n.fields.hasWithdrawalCount()||t>=1}}(this),message:i.t("app:common.validationMessages.countMustBeGreaterOrEqualsTo",{count:1})}],max:{params:2147483647,message:i.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasDepositCount",ko.observable(!1));this.form.makeField("totalDepositCountOperator",ko.observable());this.totalDepositCountOperatorTitle=ko.computed(function(){return n.getOperator(n.fields.totalDepositCountOperator())});this.form.makeField("totalDepositCountAmount",ko.observable(1).extend({formatInt:0,validatable:!0,validation:[{validator:function(){return function(t){return n.dummyObservable(),!n.fields.hasWithdrawalCount()||t>=1}}(this),message:i.t("app:common.validationMessages.countMustBeGreaterOrEqualsTo",{count:1})}],max:{params:2147483647,message:i.t("app:common.validationMessages.amountIsBiggerThenAllowed")}}));this.form.makeField("hasAccountAge",ko.observable(!1));this.form.makeField("accountAge",ko.observable(1).extend({formatInt:0,validatable:!0,validation:[{validator:function(){return function(t){return n.dummyObservable(),!n.fields.hasAccountAge()||t>=1}}(this),message:i.t("app:common.validationMessages.countMustBeGreaterOrEqualsTo",{count:1})}]}));this.form.makeField("accountAgeOperator",ko.observable());this.accountAgeOperatorTitle=ko.computed(function(){return n.getOperator(n.fields.accountAgeOperator())});this.form.makeField("id",ko.observable()).lockValue(!0);this.form.makeField("hasFraudRiskLevel",ko.observable(!1));this.form.makeField("allowWithdrawalExemption",ko.observable(!1));this.form.makeField("hasNoRecentBonus",ko.observable(!1));this.form.makeField("hasWinnings",ko.observable(!1));this.winningRules=ko.observableArray();t=this.form.makeField("currency",ko.observable().extend({required:!0})).hasOptions();t.setSerializer(function(){return t.value()}).setDisplay(ko.computed(function(){return t.value()}));r=this.form.makeField("vipLevel",ko.observable().extend({required:!0})).hasOptions();r.setSerializer(function(){var n;return n=r.value(),n?n.id:null}).setDisplay(ko.computed(function(){var n;return n=r.value(),n?n.name:null}));this.form.makeField("hasPaymentLevel",ko.observable(!1));this.paymentLevelsAssignControl=new s.AssignControl;u=this.form.makeField("paymentLevels",this.paymentLevelsAssignControl.assignedItems);u.setSerializer(function(){var n,t,i;for(t=[],i=u.value(),n=0;n<i.length;)t[n]=i[n].id,n++;return t});this.fraudRiskLevelsAssignControl=new s.AssignControl;f=this.form.makeField("riskLevels",this.fraudRiskLevelsAssignControl.assignedItems);f.setSerializer(function(){var n,t,i;for(t=[],i=f.value(),n=0;n<i.length;)t[n]=i[n].id,n++;return t});s.publishIds(this,"verification-",["licensee","brand","currency","vipLevel","hasFraudRiskLevel","hasCompleteDocuments","riskLevels","hasPaymentLevel","paymentLevels","hasWinnings","hasNoRecentBonus","allowWithdrawalExemption","hasWinLoss","winLossOperator","winLossAmount","hasTotalDepositAmount","totalDepositAmountOperator","totalDepositAmount","hasDepositCount","totalDepositCountOperator","totalDepositCountAmount","hasWithdrawalCount","totalWithdrawalCountOperator","totalWithdrawalCountAmount","hasAccountAge","accountAge","accountAgeOperator"]);s.addCommonMembers(this);this.form.publishIsReadOnly(["licensee","brand","currency","vipLevel","hasFraudRiskLevel","hasCompleteDocuments","riskLevels","hasPaymentLevel","paymentLevels","hasWinnings","hasNoRecentBonus","allowWithdrawalExemption","hasWinLoss","winLossOperator","winLossAmount","hasTotalDepositAmount","totalDepositAmountOperator","totalDepositAmount","hasDepositCount","totalDepositCountOperator","totalDepositCountAmount","hasWithdrawalCount","totalWithdrawalCountOperator","totalWithdrawalCountAmount","hasAccountAge","accountAge","accountAgeOperator"])}var r,f,e,o;return t.prototype.getBrandId=function(){var n;return n=this.form.fields.brand.value(),n?n.id:null},t.prototype.activate=function(n){var i,t;return t=this,t.fields.id(n?n.id:null),t.editMode(n?n.editMode:!1),t.submitted(t.editMode()===!1),i=$.Deferred(),t.fields.id()?(t.loadConfiguration(i),t.submitted(this.editMode()===!1)):this.load(i),i.promise()},t.prototype.loadConfiguration=function(n){var t;return t=this,$.ajax("autoVerification/GetById?id="+this.fields.id(),{success:function(i){return t.load(n,i)}})},t.prototype.compositionComplete=function(){return this},t.prototype.formatDate=function(n){var i,r,t,u;return t=this,u=n.getFullYear(),r=n.getMonth()+1,i=n.getDate(),u+"/"+t.formatDateNumber(r)+"/"+t.formatDateNumber(i)},t.prototype.formatDateNumber=function(n){return n<10?"0"+n:n},t.prototype.load=function(n,t){var r,f,i;return i=this,t&&(this.configuration=t,i.fields.hasWinnings(t.hasWinnings),i.fields.hasCompleteDocuments(t.hasCompleteDocuments),i.fields.hasWinLoss(t.hasWinLoss),i.fields.winLossAmount(t.winLossAmount),i.fields.winLossOperator(t.winLossOperator),i.fields.hasTotalDepositAmount(t.hasTotalDepositAmount),i.fields.totalDepositAmount(t.totalDepositAmount),i.fields.totalDepositAmountOperator(t.totalDepositAmountOperator),i.fields.hasDepositCount(t.hasDepositCount),i.fields.totalDepositCountAmount(t.totalDepositCountAmount),i.fields.totalDepositCountOperator(t.totalDepositCountOperator),i.fields.hasWithdrawalCount(t.hasWithdrawalCount),i.fields.totalWithdrawalCountAmount(t.totalWithdrawalCountAmount),i.fields.totalWithdrawalCountOperator(t.totalWithdrawalCountOperator),i.fields.hasAccountAge(t.hasAccountAge),i.fields.accountAge(t.accountAge),i.fields.accountAgeOperator(t.accountAgeOperator),i.fields.hasFraudRiskLevel(t.hasFraudRiskLevel),i.fields.hasPaymentLevel(t.hasPaymentLevel)),f=function(){return"Licensee/GetLicensees"},r=function(){return"Licensee/GetBrands?licensee="+i.form.fields.licensee.value().id},s.loadLicensees2(f,i.form.fields.licensee,function(){var f,e;return f=s.getBrandLicenseeId(u),e=i.form.fields.licensee.options(),t&&(f=t.licensee,i.form.fields.licensee.isSet(!0)),s.selectLicensee2(i.form.fields.licensee,f),s.loadBrands2(r,i.form.fields.brand,function(){var f;return f=t?t.brand:u.brand().id(),s.selectBrand2(i.form.fields.brand,f),t&&i.form.fields.brand.isSet(!0),i.loadCurrencies(function(){return i.loadVipLevels(function(){return i.loadFraudRisks(function(){var r;return t&&t.brand===f&&(r=[],i.fraudRiskLevelsAssignControl.availableItems().forEach(function(n){return r.push(n)}),r.forEach(function(n){return i.fraudRiskLevelsAssignControl.selectedAvailableItems.push(n),i.fraudRiskLevelsAssignControl.assign()}),r=[],i.fraudRiskLevelsAssignControl.assignedItems().forEach(function(n){return i.configuration.riskLevels.forEach(function(t){if(n.id===t)return r.push(n)})}),r.forEach(function(n){return i.fraudRiskLevelsAssignControl.selectedAssignedItems.push(n),i.fraudRiskLevelsAssignControl.unassign()})),i.loadProducts(function(){return t&&t.hasWinnings?t.winningRules.forEach(function(){return function(n){var t;return t=new h(i.products),t.loadFromRuleDTO(n),i.winningRules.push(t)}}(this)):i.winningRules.push(new h(i.products)),n.resolve()})}),i.loadPaymentLevels(function(){var n;if(t&&t.brand===f)return n=[],i.paymentLevelsAssignControl.availableItems().forEach(function(t){return n.push(t)}),n.forEach(function(n){return i.paymentLevelsAssignControl.selectedAvailableItems.push(n),i.paymentLevelsAssignControl.assign()}),n=[],i.paymentLevelsAssignControl.assignedItems().forEach(function(t){return i.configuration.paymentLevels.forEach(function(i){if(t.id===i)return n.push(t)})}),n.forEach(function(n){return i.paymentLevelsAssignControl.selectedAssignedItems.push(n),i.paymentLevelsAssignControl.unassign()})})}),t&&s.selectOption(i.form.fields.currency,function(n){return n===t.currency}),i.form.fields.licensee.value.subscribe(function(){return s.loadBrands2(r,i.form.fields.brand)}),i.form.fields.brand.value.subscribe(function(){var n,t,r,u,f;return $(i.uiElement).parent().hide().prev().show(),n=$.Deferred(),i.loadCurrencies(function(){return n.resolve()}),f=$.Deferred(),i.loadVipLevels(function(){return f.resolve()}),u=$.Deferred(),i.loadProducts(function(){return i.winningRules.removeAll(),i.winningRules.push(new h(i.products)),u.resolve()}),t=$.Deferred(),i.loadFraudRisks(function(){return t.resolve()}),r=$.Deferred(),i.loadPaymentLevels(function(){return r.resolve()}),$.when(r,t,u,f,n).done(function(){return $(i.uiElement).parent().show().prev().hide()})}),i.form.fields.currency.value.subscribe(function(){var n;return n=$.Deferred(),i.loadPaymentLevels(function(){return n.resolve()})})})})})},t.prototype.loadVipLevels=function(n,t){var r,i;return i=this,r=i.getBrandId(),r?$.ajax("paymentsettings/getviplevels?brandId="+r).done(function(r){var u,f;return i.form.fields.vipLevel.setOptions(r.vipLevels),u=function(n){var t,f,i,u;for(i=r.vipLevels,t=0,f=i.length;t<f;t++)if(u=i[t],u.id===n)return u},i.configuration.vipLevel&&(f=u(i.configuration.vipLevel),i.form.fields.vipLevel.value(f)),s.callCallback(n,t)}):s.callCallback(n,t)},t.prototype.loadFraudRisks=function(n,t){var r,i;return i=this,r=i.getBrandId(),r?$.ajax("autoverification/getfraudrisklevels?brandId="+r).done(function(r){return i.fraudRiskLevelsAssignControl.assignedItems([]),i.fraudRiskLevelsAssignControl.availableItems(r.riskLevels),s.callCallback(n,t)}):s.callCallback(n,t)},t.prototype.loadPaymentLevels=function(n,t){var r,u,i;return i=this,r=i.getBrandId(),u=typeof i.fields.currency()!="undefined"?i.fields.currency():i.form.fields.currency.options()[0],r&&u?$.ajax("autoverification/getpaymentlevels?brandId="+r+"&currencyCode="+u).done(function(r){return i.paymentLevelsAssignControl.assignedItems([]),i.paymentLevelsAssignControl.availableItems(r.paymentLevels),s.callCallback(n,t)}):s.callCallback(n,t)},t.prototype.removeWinningRule=function(n){return this.winningRules.remove(n)},t.prototype.addWinningRule=function(){return this.winningRules.push(new h(this.products))},t.prototype.getOperator=function(n){return n===0?">":n===1?"<":n===2?">=":n===3?"<=":void 0},t.prototype.loadCurrencies=function(n,t){var i,r;return r=this,i=r.getBrandId(),i?$.ajax("autoverification/getcurrencies?brandId="+i).done(function(i){return r.form.fields.currency.setOptions(i.currencies),s.callCallback(n,t)}):s.callCallback(n,t)},t.prototype.loadProducts=function(n,t){var i,r;return r=this,i=r.getBrandId(),i?$.ajax("autoverification/GetAllowedBrandProducts?brandId="+i).done(function(i){return r.products=i,s.callCallback(n,t)}):s.callCallback(n,t)},e={gridBodyId:"verification-manager-list",editUrl:"autoverification/verification"},s.addCommonEditFunctions(t.prototype,e),t.prototype.serializeForm=function(){var n;return n=this.form.getDataObject(),this.fields.hasWinnings()&&(n.winningRules=_.map(this.winningRules(),function(n){return{startDate:n.startDate(),endDate:n.endDate(),productId:n.selectedProduct(),amount:n.amount(),comparison:n.comparisonOperator(),period:n.selectedPeriod()}})),JSON.stringify(n)},o=t.prototype.save,t.prototype.save=function(){var n,t,r,u;return n=!1,this.dummyObservable(new Date),this.fields.hasWinnings()&&(this.winningRules().forEach(function(){return function(n){return n.validate()}}(this)),n=_.some(this.winningRules(),function(n){return n.errorMessage()}),n||(r=this.winningRules().length,t=_.map(this.winningRules(),function(n){return n.selectedProduct()}),u=_.uniq(t),r!==u.length&&(n=!0,this.message(i.t("app:fraud.autoVerification.messages.oneRulePerProductAllowed")),this.messageClass("alert alert-danger")))),n?void 0:o.call(this)},f=t.prototype.handleSaveSuccess,t.prototype.handleSaveSuccess=function(t){return t.data=i.t("app:fraud.autoVerification.messages.successfullyCreated"),f.call(this,t),n.title("View Auto Verification Configuration")},r=t.prototype.handleSaveFailure,t.prototype.handleSaveFailure=function(t){return t.data=i.t("app:fraud.autoVerification.messages."+t.data),r.call(this,t),n.title("Auto Verification Configuration Failure")},t}()})}).call(this);
//# sourceMappingURL=edit.min.js.map
